<app-layout-principal>
  <div class="conteudo-principal">

    <!-- LISTA DE PRONTUÁRIOS -->
    <h4>Prontuários Cadastrados</h4>
    <div *ngIf="medicalRecords.length === 0" class="alert alert-info">Nenhum prontuário encontrado.</div>

    <div *ngFor="let record of medicalRecords" class="card mb-3 p-3">
      <div>
        <strong>Paciente:</strong> {{ getPatientName(record.patient?.id) }}
      </div>
      <div>
        <strong>Data da Consulta:</strong> {{ record.consultations?.[0]?.dateTime | date:'short' }}
      </div>
      <div>
        <strong>Especialidade:</strong> {{ record.consultations?.[0]?.specialty }}
      </div>

      <div class="mt-2 d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" (click)="visualizarProntuario(record)">Visualizar</button>
        <button class="btn btn-outline-warning btn-sm" (click)="editarProntuario(record)">Editar</button>
        <button class="btn btn-outline-danger btn-sm" (click)="excluirProntuario(record.id!)">Excluir</button>
      </div>

      <div *ngIf="selectedMedicalRecord?.id === record.id && !editando" class="mt-3">
        <h6>Consultas:</h6>
        <ul>
          <li *ngFor="let consult of record.consultations">
            <strong>Data:</strong> {{ consult.dateTime | date:'short' }} |
            <strong>Especialidade:</strong> {{ consult.specialty }} |
            <strong>Status:</strong> <span [ngClass]="getStatusClass(consult.status)">{{ getStatusText(consult.status) }}</span> |
            <strong>Relatório:</strong> {{ consult.report?.body }}
          </li>
        </ul>
      </div>
    </div>

    <hr />

    <!-- BOTÃO PARA CRIAR NOVO PRONTUÁRIO -->
    <div class="mb-3">
      <button class="btn btn-primary" (click)="novoProntuario">Novo Prontuário</button>
    </div>

    <!-- FORMULÁRIO DE PRONTUÁRIO -->
    <form *ngIf="editando || criando" [formGroup]="formProntuario" (ngSubmit)="salvarProntuario()" class="form-prontuario p-3">

      <h3>{{ editando ? 'Editar Prontuário' : 'Novo Prontuário' }}</h3>

      <!-- Seleção do Paciente -->
      <div class="mb-3">
        <label for="patientId" class="form-label">Paciente:</label>
        <select id="patientId" formControlName="patientId" class="form-select">
          <option [value]="null" disabled>Selecione um paciente</option>
          <option *ngFor="let p of patients" [value]="p.id">{{ p.name }}</option>
        </select>
      </div>

      <!-- Data e Especialidade (campo padrão do prontuário, usado só no primeiro registro) -->
      <div class="mb-3">
        <label for="consultationDateTime" class="form-label">Data da Consulta:</label>
        <input type="datetime-local" id="consultationDateTime" formControlName="consultationDateTime" class="form-control" />
      </div>

      <div class="mb-3">
        <label for="specialty" class="form-label">Especialidade:</label>
        <input type="text" id="specialty" formControlName="specialty" class="form-control" />
      </div>

      <!-- CONSULTAS (FormArray) -->
      <div formArrayName="consultations" class="mb-3">
        <h5>Consultas</h5>

        <div
          *ngFor="let consulta of consultations.controls; let i = index"
          [formGroupName]="i"
          class="card mb-2 p-3"
        >
          <label>Consulta {{ i + 1 }}</label>

          <div class="mb-2">
            <label class="form-label">Relatório (JSON):</label>
            <textarea formControlName="report" class="form-control" rows="3"></textarea>
          </div>

          <div class="mb-2">
            <label class="form-label">Especialidade:</label>
            <input type="text" formControlName="specialty" class="form-control" />
          </div>

          <div class="mb-2">
            <label class="form-label">Status:</label>
            <select formControlName="status" class="form-select">
              <option [value]="StatusConsultation.PENDING">Pendente</option>
              <option [value]="StatusConsultation.FINISHED">Finalizado</option>
              <option [value]="StatusConsultation.CANCELLED">Cancelado</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">Data e Hora:</label>
            <input type="datetime-local" formControlName="dateTime" class="form-control" />
          </div>

          <button type="button" class="btn btn-danger btn-sm" (click)="removeConsultationItem(i)" *ngIf="consultations.length > 1">
            Remover Consulta
          </button>
        </div>

        <button type="button" class="btn btn-primary btn-sm" (click)="addConsultationItem()">
          Adicionar Consulta
        </button>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-success">{{ editando ? 'Atualizar Prontuário' : 'Salvar Prontuário' }}</button>
        <button type="button" class="btn btn-secondary" (click)="limparFormulario()">Cancelar</button>
      </div>
    </form>
  </div>
</app-layout-principal>
